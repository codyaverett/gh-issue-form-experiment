name: Three-Stage Wizard Flow

on:
  issues:
    types: [opened, edited]

jobs:
  # ============================================
  # Handle all wizard form submissions
  # ============================================
  process-wizard-form:
    runs-on: ubuntu-latest
    # Check if any label name equals 'wizard'
    if: ${{ contains(join(github.event.issue.labels.*.name, ','), 'wizard') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Stage and Parse Form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const labels = context.payload.issue.labels.map(l => l.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;

            console.log(`Processing issue #${issueNumber}: ${issueTitle}`);
            console.log(`Labels: ${labels.join(', ')}`);

            // Determine current stage
            let stage = 0;
            if (labels.includes('stage-1')) stage = 1;
            else if (labels.includes('stage-2')) stage = 2;
            else if (labels.includes('stage-3')) stage = 3;

            console.log(`Current stage: ${stage}`);

            // Parse form body (### Header\n\nValue format)
            const formData = {};
            const sections = body.split(/^### /gm).filter(Boolean);

            for (const section of sections) {
              const lines = section.split('\n');
              const header = lines[0].trim();
              const content = lines.slice(1).join('\n').trim();

              // Convert header to camelCase
              const key = header
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .trim()
                .replace(/\s+(.)/g, (_, c) => c.toUpperCase());

              // Parse content
              if (!content || content === '_No response_') {
                formData[key] = null;
              } else if (/^- \[[ xX]\]/m.test(content)) {
                // Checkboxes
                formData[key] = content.split('\n')
                  .filter(l => /^- \[[ xX]\]/.test(l.trim()))
                  .map(l => ({
                    label: l.replace(/^- \[[ xX]\]\s*/, '').trim(),
                    checked: /^- \[[xX]\]/.test(l.trim())
                  }));
              } else {
                formData[key] = content;
              }
            }

            console.log('Parsed form data:', JSON.stringify(formData, null, 2));

            // Get or create workflow ID
            let workflowId = formData.workflowId;
            if (!workflowId || workflowId === '_No response_') {
              workflowId = `wizard-${context.runId}`;
            }

            core.setOutput('stage', stage.toString());
            core.setOutput('workflow_id', workflowId);
            core.setOutput('form_data', JSON.stringify(formData));
            core.setOutput('issue_number', issueNumber.toString());

      - name: Close Current Form Issue
        uses: actions/github-script@v7
        with:
          script: |
            const stage = parseInt('${{ steps.parse.outputs.stage }}');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Stage ${stage} Complete ‚úì\n\nForm data received. ${stage < 3 ? 'Creating next stage form...' : 'Processing final submission...'}\n\nWorkflow ID: \`${{ steps.parse.outputs.workflow_id }}\``
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      # ----------------------------------------
      # Stage 1 -> Create Stage 2 form
      # ----------------------------------------
      - name: "Stage 1 ‚Üí Create Stage 2 Form"
        if: steps.parse.outputs.stage == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';

            // Save state for later stages
            const state = {
              stage1: formData,
              workflowId: workflowId
            };

            // Create Stage 2 form issue
            const stage2Body = `### Workflow ID

            ${workflowId}

            ### Primary Language

            _No response_

            ### Framework

            _No response_

            ### Required Features

            - [ ] Database (PostgreSQL/MySQL)
            - [ ] Redis Cache
            - [ ] Message Queue
            - [ ] File Storage (S3)
            - [ ] Authentication
            - [ ] CI/CD Pipeline

            ### Target Environment

            _No response_

            ---
            **Project from Stage 1:**
            - **Name:** ${formData.projectName}
            - **Type:** ${formData.projectType}
            - **Team:** ${formData.teamSize}`;

            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[TECH CONFIG] ${formData.projectName}`,
              body: stage2Body,
              labels: ['form-submission', 'stage-2', 'wizard']
            });

            // Store state in a state issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[STATE] ${workflowId}`,
              body: `## Wizard State\n\n\`\`\`json\n${JSON.stringify(state, null, 2)}\n\`\`\``,
              labels: ['workflow-state']
            });

            console.log(`Created Stage 2 form: #${newIssue.data.number}`);
            console.log(`Stage 2 URL: ${newIssue.data.html_url}`);

            // Comment on original with link
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              body: `## Next Step: Stage 2\n\nPlease continue with the technical configuration:\n\n**‚Üí #${newIssue.data.number}**`
            });

      # ----------------------------------------
      # Stage 2 -> Create Stage 3 form
      # ----------------------------------------
      - name: "Stage 2 ‚Üí Create Stage 3 Form"
        if: steps.parse.outputs.stage == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';

            // Load existing state
            const stateIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'workflow-state',
              state: 'open'
            });

            const stateIssue = stateIssues.data.find(i => i.title.includes(workflowId));
            let state = { stage1: {}, stage2: formData };

            if (stateIssue) {
              const match = stateIssue.body.match(/```json\n([\s\S]*?)\n```/);
              if (match) {
                state = JSON.parse(match[1]);
                state.stage2 = formData;
              }

              // Update state issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: stateIssue.number,
                body: `## Wizard State\n\n\`\`\`json\n${JSON.stringify(state, null, 2)}\n\`\`\``
              });
            }

            // Build summary for review
            const stage1 = state.stage1 || {};
            const features = (formData.requiredFeatures || [])
              .filter(f => f.checked)
              .map(f => `- ${f.label}`)
              .join('\n') || '- None selected';

            const summary = `| Setting | Value |
            |---------|-------|
            | **Project Name** | ${stage1.projectName || 'N/A'} |
            | **Project Type** | ${stage1.projectType || 'N/A'} |
            | **Team Size** | ${stage1.teamSize || 'N/A'} |
            | **Owner** | ${stage1.ownerEmail || 'N/A'} |
            | **Language** | ${formData.primaryLanguage || 'N/A'} |
            | **Framework** | ${formData.framework || 'N/A'} |
            | **Environment** | ${formData.targetEnvironment || 'N/A'} |

            **Features:**
            ${features}

            **Description:**
            ${stage1.projectDescription || 'N/A'}`;

            // Create Stage 3 form
            const stage3Body = `### Workflow ID

            ${workflowId}

            ### Project Summary

            ${summary}

            ### Confirmation

            _No response_

            ### Additional Notes

            _No response_

            ### Acknowledgments

            - [ ] I have reviewed all the project details
            - [ ] I understand this will create resources`;

            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CONFIRM] ${stage1.projectName || 'Project'}`,
              body: stage3Body,
              labels: ['form-submission', 'stage-3', 'wizard']
            });

            console.log(`Created Stage 3 form: #${newIssue.data.number}`);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              body: `## Next Step: Stage 3 (Final)\n\nPlease review and confirm:\n\n**‚Üí #${newIssue.data.number}**`
            });

      # ----------------------------------------
      # Stage 3 -> Complete workflow
      # ----------------------------------------
      - name: "Stage 3 ‚Üí Complete Wizard"
        if: steps.parse.outputs.stage == '3'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';

            // Load full state
            const stateIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'workflow-state',
              state: 'open'
            });

            const stateIssue = stateIssues.data.find(i => i.title.includes(workflowId));
            let fullState = {};

            if (stateIssue) {
              const match = stateIssue.body.match(/```json\n([\s\S]*?)\n```/);
              if (match) {
                fullState = JSON.parse(match[1]);
              }
            }

            fullState.stage3 = formData;

            const confirmed = formData.confirmation === 'Yes, proceed';

            console.log('='.repeat(50));
            console.log('WIZARD COMPLETE');
            console.log('='.repeat(50));
            console.log(`Workflow ID: ${workflowId}`);
            console.log(`Confirmed: ${confirmed}`);
            console.log('Full collected data:');
            console.log(JSON.stringify(fullState, null, 2));
            console.log('='.repeat(50));

            // Create final summary
            const stage1 = fullState.stage1 || {};
            const stage2 = fullState.stage2 || {};
            const features = (stage2.requiredFeatures || [])
              .filter(f => f.checked)
              .map(f => `‚úì ${f.label}`)
              .join('\n') || 'None';

            const finalSummary = `## Wizard Complete ${confirmed ? '‚úÖ' : '‚ùå'}

            **Status:** ${confirmed ? 'CONFIRMED - Resources will be created' : 'CANCELLED'}

            ### Collected Data

            | Stage | Field | Value |
            |-------|-------|-------|
            | 1 | Project Name | ${stage1.projectName || '-'} |
            | 1 | Project Type | ${stage1.projectType || '-'} |
            | 1 | Team Size | ${stage1.teamSize || '-'} |
            | 1 | Owner Email | ${stage1.ownerEmail || '-'} |
            | 2 | Language | ${stage2.primaryLanguage || '-'} |
            | 2 | Framework | ${stage2.framework || '-'} |
            | 2 | Environment | ${stage2.targetEnvironment || '-'} |
            | 3 | Confirmation | ${formData.confirmation || '-'} |

            ### Features Selected
            \`\`\`
            ${features}
            \`\`\`

            ### Project Description
            > ${stage1.projectDescription || 'N/A'}

            ${formData.additionalNotes ? `### Additional Notes\n> ${formData.additionalNotes}` : ''}

            ---
            **Workflow ID:** \`${workflowId}\`
            **Run ID:** \`${{ github.run_id }}\``;

            // Post final summary
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.issue_number }},
              body: finalSummary
            });

            // Close state issue
            if (stateIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: stateIssue.number,
                state: 'closed'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: stateIssue.number,
                body: `Wizard completed. Final state:\n\n\`\`\`json\n${JSON.stringify(fullState, null, 2)}\n\`\`\``
              });
            }

            if (confirmed) {
              console.log('üéâ Project confirmed! Would trigger resource creation here.');
              // Here you would trigger actual resource creation workflows
            } else {
              console.log('‚ùå Project cancelled by user.');
            }
