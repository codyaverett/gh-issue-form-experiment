name: Three-Stage Wizard Flow (Single Issue)

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  # ============================================
  # Stage 1: Process initial form submission
  # ============================================
  process-stage-1:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      contains(join(github.event.issue.labels.*.name, ','), 'wizard') &&
      contains(join(github.event.issue.labels.*.name, ','), 'stage-1')

    steps:
      - name: Parse Stage 1 Form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            console.log('Parsing Stage 1 form...');

            // Parse form body (### Header\n\nValue format)
            const formData = {};
            const sections = body.split(/^### /gm).filter(Boolean);

            for (const section of sections) {
              const lines = section.split('\n');
              const header = lines[0].trim();
              const content = lines.slice(1).join('\n').trim();

              const key = header
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .trim()
                .replace(/\s+(.)/g, (_, c) => c.toUpperCase());

              if (!content || content === '_No response_') {
                formData[key] = null;
              } else {
                formData[key] = content;
              }
            }

            console.log('Stage 1 data:', JSON.stringify(formData, null, 2));
            core.setOutput('form_data', JSON.stringify(formData));
            return formData;

      - name: Post Stage 2 Template & Update Labels
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const repo = context.repo;
            const issueNumber = context.issue.number;

            // Post Stage 2 comment template
            const stage2Template = `## âœ… Stage 1 Complete!

            **Project:** ${formData.projectName || 'N/A'}
            **Type:** ${formData.projectType || 'N/A'}
            **Team Size:** ${formData.teamSize || 'N/A'}
            **Owner:** ${formData.projectOwnerEmail || 'N/A'}

            ---

            ## ðŸ“ Stage 2: Technical Configuration

            **Please reply to this issue** with your technical choices. Copy the template below and fill it in:

            \`\`\`
            **Language:** TypeScript
            **Framework:** React
            **Environment:** Dev + Staging + Production

            **Features:**
            - Database (PostgreSQL/MySQL)
            - Authentication
            - CI/CD Pipeline
            \`\`\`

            ### Available Options:

            | Field | Options |
            |-------|---------|
            | Language | TypeScript, JavaScript, Python, Go, Rust, Java |
            | Framework | React, Vue, Next.js, Express, FastAPI, Django, None |
            | Environment | Development Only, Dev + Staging, Dev + Staging + Production |

            **Features** (list the ones you need):
            - Database (PostgreSQL/MySQL)
            - Redis Cache
            - Message Queue
            - File Storage (S3)
            - Authentication
            - CI/CD Pipeline`;

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: stage2Template
            });

            // Update labels: remove stage-1, add awaiting-stage-2
            const currentLabels = context.payload.issue.labels.map(l => l.name);
            const newLabels = currentLabels
              .filter(l => l !== 'stage-1')
              .concat(['awaiting-stage-2']);

            await github.rest.issues.setLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              labels: newLabels
            });

            console.log('Stage 1 complete, awaiting Stage 2 input');

  # ============================================
  # Stage 2: Process comment with technical config
  # ============================================
  process-stage-2:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      contains(join(github.event.issue.labels.*.name, ','), 'awaiting-stage-2') &&
      github.event.comment.user.login != 'github-actions[bot]'

    steps:
      - name: Parse Stage 2 Comment
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            console.log('Parsing Stage 2 comment...');
            console.log('Raw comment:', comment);

            // Parse **Field:** Value format
            const formData = {};

            // Extract simple fields
            const fieldPattern = /\*\*(\w+):\*\*\s*(.+)/g;
            let match;
            while ((match = fieldPattern.exec(comment)) !== null) {
              const key = match[1].toLowerCase();
              const value = match[2].trim();
              formData[key] = value;
            }

            // Extract features list
            const featuresMatch = comment.match(/\*\*Features:\*\*\s*([\s\S]*?)(?=\*\*|$)/);
            if (featuresMatch) {
              const featuresText = featuresMatch[1];
              const features = featuresText
                .split('\n')
                .map(l => l.replace(/^-\s*/, '').trim())
                .filter(l => l.length > 0);
              formData.features = features;
            }

            console.log('Stage 2 data:', JSON.stringify(formData, null, 2));
            core.setOutput('form_data', JSON.stringify(formData));
            return formData;

      - name: Post Stage 3 Template & Update Labels
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const repo = context.repo;
            const issueNumber = context.issue.number;

            const featuresList = (formData.features || []).map(f => `- ${f}`).join('\n') || '- None specified';

            // Post Stage 3 comment template
            const stage3Template = `## âœ… Stage 2 Complete!

            **Language:** ${formData.language || 'N/A'}
            **Framework:** ${formData.framework || 'N/A'}
            **Environment:** ${formData.environment || 'N/A'}

            **Features:**
            ${featuresList}

            ---

            ## ðŸ“ Stage 3: Review & Confirm

            Please review all your selections above and **reply to confirm**.

            Copy and fill in:

            \`\`\`
            **Confirmation:** Yes, proceed
            **Additional Notes:** Any special instructions or notes
            \`\`\`

            | Confirmation Options |
            |---------------------|
            | Yes, proceed |
            | No, cancel |`;

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: stage3Template
            });

            // Update labels: remove awaiting-stage-2, add awaiting-stage-3
            const currentLabels = context.payload.issue.labels.map(l => l.name);
            const newLabels = currentLabels
              .filter(l => l !== 'awaiting-stage-2')
              .concat(['awaiting-stage-3']);

            await github.rest.issues.setLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              labels: newLabels
            });

            console.log('Stage 2 complete, awaiting Stage 3 input');

  # ============================================
  # Stage 3: Process confirmation and complete
  # ============================================
  process-stage-3:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      contains(join(github.event.issue.labels.*.name, ','), 'awaiting-stage-3') &&
      github.event.comment.user.login != 'github-actions[bot]'

    steps:
      - name: Parse Stage 3 Comment
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            console.log('Parsing Stage 3 comment...');

            const formData = {};

            // Extract confirmation
            const confirmMatch = comment.match(/\*\*Confirmation:\*\*\s*(.+)/i);
            if (confirmMatch) {
              formData.confirmation = confirmMatch[1].trim();
            }

            // Extract notes
            const notesMatch = comment.match(/\*\*Additional Notes:\*\*\s*(.+)/i);
            if (notesMatch) {
              formData.notes = notesMatch[1].trim();
            }

            console.log('Stage 3 data:', JSON.stringify(formData, null, 2));
            core.setOutput('form_data', JSON.stringify(formData));
            core.setOutput('confirmed', (formData.confirmation || '').toLowerCase().includes('yes') ? 'true' : 'false');
            return formData;

      - name: Load All Stage Data from Comments
        id: load-all
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const issueNumber = context.issue.number;

            // Get issue body (Stage 1 data)
            const issue = await github.rest.issues.get({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber
            });

            // Parse Stage 1 from issue body
            const body = issue.data.body;
            const stage1 = {};
            const sections = body.split(/^### /gm).filter(Boolean);
            for (const section of sections) {
              const lines = section.split('\n');
              const header = lines[0].trim();
              const content = lines.slice(1).join('\n').trim();
              const key = header.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim().replace(/\s+(.)/g, (_, c) => c.toUpperCase());
              if (content && content !== '_No response_') {
                stage1[key] = content;
              }
            }

            // Get all comments to find Stage 2 user response
            const comments = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber
            });

            // Find user comments (not bot)
            const userComments = comments.data.filter(c => !c.user.login.includes('[bot]'));

            // Parse Stage 2 from first user comment after Stage 1
            let stage2 = {};
            if (userComments.length >= 1) {
              const s2Comment = userComments[0].body;
              const fieldPattern = /\*\*(\w+):\*\*\s*(.+)/g;
              let match;
              while ((match = fieldPattern.exec(s2Comment)) !== null) {
                stage2[match[1].toLowerCase()] = match[2].trim();
              }
              const featuresMatch = s2Comment.match(/\*\*Features:\*\*\s*([\s\S]*?)(?=\*\*|$)/);
              if (featuresMatch) {
                stage2.features = featuresMatch[1].split('\n').map(l => l.replace(/^-\s*/, '').trim()).filter(Boolean);
              }
            }

            const allData = { stage1, stage2 };
            console.log('All collected data:', JSON.stringify(allData, null, 2));
            core.setOutput('all_data', JSON.stringify(allData));

      - name: Post Final Summary & Close Issue
        uses: actions/github-script@v7
        with:
          script: |
            const stage3 = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const allData = JSON.parse('${{ steps.load-all.outputs.all_data }}');
            const confirmed = '${{ steps.parse.outputs.confirmed }}' === 'true';
            const repo = context.repo;
            const issueNumber = context.issue.number;

            const stage1 = allData.stage1 || {};
            const stage2 = allData.stage2 || {};
            const features = (stage2.features || []).map(f => `âœ“ ${f}`).join('\n') || 'None';

            const finalSummary = `## ðŸŽ‰ Wizard Complete ${confirmed ? 'âœ…' : 'âŒ'}

            **Status:** ${confirmed ? 'CONFIRMED - Ready for resource creation!' : 'CANCELLED'}

            ---

            ### ðŸ“‹ Complete Project Summary

            | Stage | Field | Value |
            |-------|-------|-------|
            | 1 | Project Name | ${stage1.projectName || '-'} |
            | 1 | Project Type | ${stage1.projectType || '-'} |
            | 1 | Team Size | ${stage1.teamSize || '-'} |
            | 1 | Owner | ${stage1.projectOwnerEmail || '-'} |
            | 2 | Language | ${stage2.language || '-'} |
            | 2 | Framework | ${stage2.framework || '-'} |
            | 2 | Environment | ${stage2.environment || '-'} |
            | 3 | Confirmation | ${stage3.confirmation || '-'} |

            ### Features
            \`\`\`
            ${features}
            \`\`\`

            ### Project Description
            > ${stage1.projectDescription || 'N/A'}

            ${stage3.notes ? `### Additional Notes\n> ${stage3.notes}` : ''}

            ---
            **Run ID:** \`${{ github.run_id }}\``;

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body: finalSummary
            });

            // Update labels and close
            const currentLabels = context.payload.issue.labels.map(l => l.name);
            const newLabels = currentLabels
              .filter(l => !l.startsWith('awaiting-') && l !== 'stage-1')
              .concat(['completed']);

            await github.rest.issues.setLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              labels: newLabels
            });

            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

            console.log('Wizard complete!', confirmed ? 'Confirmed' : 'Cancelled');
