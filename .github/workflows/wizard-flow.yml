name: Three-Stage Wizard Flow

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  process-wizard-form:
    runs-on: ubuntu-latest
    if: ${{ contains(join(github.event.issue.labels.*.name, ','), 'wizard') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Stage and Parse Form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const labels = context.payload.issue.labels.map(l => l.name);
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;

            console.log(`Processing issue #${issueNumber}: ${issueTitle}`);
            console.log(`Labels: ${labels.join(', ')}`);

            // Determine current stage
            let stage = 0;
            if (labels.includes('stage-1')) stage = 1;
            else if (labels.includes('stage-2')) stage = 2;
            else if (labels.includes('stage-3')) stage = 3;

            console.log(`Current stage: ${stage}`);

            // Parse form body (### Header\n\nValue format)
            const formData = {};
            const sections = body.split(/^### /gm).filter(Boolean);

            for (const section of sections) {
              const lines = section.split('\n');
              const header = lines[0].trim();
              const content = lines.slice(1).join('\n').trim();

              // Convert header to camelCase
              const key = header
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .trim()
                .replace(/\s+(.)/g, (_, c) => c.toUpperCase());

              // Parse content
              if (!content || content === '_No response_') {
                formData[key] = null;
              } else if (/^- \[[ xX]\]/m.test(content)) {
                // Checkboxes
                formData[key] = content.split('\n')
                  .filter(l => /^- \[[ xX]\]/.test(l.trim()))
                  .map(l => ({
                    label: l.replace(/^- \[[ xX]\]\s*/, '').trim(),
                    checked: /^- \[[xX]\]/.test(l.trim())
                  }));
              } else {
                formData[key] = content;
              }
            }

            console.log('Parsed form data:', JSON.stringify(formData, null, 2));

            // Get or create workflow ID
            let workflowId = formData.workflowId;
            if (!workflowId || workflowId === '_No response_' || workflowId === null) {
              workflowId = `wizard-${context.runId}`;
            }

            core.setOutput('stage', stage.toString());
            core.setOutput('workflow_id', workflowId);
            core.setOutput('form_data', JSON.stringify(formData));
            core.setOutput('issue_number', issueNumber.toString());

      # ----------------------------------------
      # Stage 1 -> Link to Stage 2 form
      # ----------------------------------------
      - name: "Stage 1 → Provide Stage 2 Form Link"
        if: steps.parse.outputs.stage == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';
            const repo = context.repo;

            // Save state for later stages
            const state = {
              stage1: formData,
              workflowId: workflowId,
              originalIssue: context.issue.number
            };

            // Store state in a state issue
            await github.rest.issues.create({
              owner: repo.owner,
              repo: repo.repo,
              title: `[STATE] ${workflowId}`,
              body: `## Wizard State\n\n\`\`\`json\n${JSON.stringify(state, null, 2)}\n\`\`\``,
              labels: ['workflow-state']
            });

            // Build pre-filled URL for Stage 2 form
            const stage2Url = `https://github.com/${repo.owner}/${repo.repo}/issues/new?template=stage-2-technical.yml&workflow_id=${encodeURIComponent(workflowId)}`;

            // Close current issue and provide link to next stage
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: `## Stage 1 Complete ✓

            **Project:** ${formData.projectName}
            **Type:** ${formData.projectType}
            **Team:** ${formData.teamSize}

            ---

            ### Next Step: Stage 2 - Technical Configuration

            Click the link below to continue with the interactive form:

            ### **[→ Continue to Stage 2](${stage2Url})**

            ---
            Workflow ID: \`${workflowId}\``
            });

            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: [...context.payload.issue.labels.map(l => l.name), 'processed']
            });

            console.log(`Stage 2 form URL: ${stage2Url}`);

      # ----------------------------------------
      # Stage 2 -> Link to Stage 3 form
      # ----------------------------------------
      - name: "Stage 2 → Provide Stage 3 Form Link"
        if: steps.parse.outputs.stage == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';
            const repo = context.repo;

            // Load existing state
            const stateIssues = await github.rest.issues.listForRepo({
              owner: repo.owner,
              repo: repo.repo,
              labels: 'workflow-state',
              state: 'open'
            });

            const stateIssue = stateIssues.data.find(i => i.title.includes(workflowId));
            let state = { stage1: {}, stage2: formData };

            if (stateIssue) {
              const match = stateIssue.body.match(/```json\n([\s\S]*?)\n```/);
              if (match) {
                state = JSON.parse(match[1]);
                state.stage2 = formData;
              }

              // Update state issue
              await github.rest.issues.update({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: stateIssue.number,
                body: `## Wizard State\n\n\`\`\`json\n${JSON.stringify(state, null, 2)}\n\`\`\``
              });
            }

            // Build summary for display
            const stage1 = state.stage1 || {};
            const features = (formData.requiredFeatures || [])
              .filter(f => f.checked)
              .map(f => `✓ ${f.label}`)
              .join('\n') || 'None selected';

            // Build pre-filled URL for Stage 3 form
            const stage3Url = `https://github.com/${repo.owner}/${repo.repo}/issues/new?template=stage-3-review.yml&workflow_id=${encodeURIComponent(workflowId)}`;

            // Close current issue and provide link to next stage
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: `## Stage 2 Complete ✓

            **Language:** ${formData.primaryLanguage || 'N/A'}
            **Framework:** ${formData.framework || 'N/A'}
            **Environment:** ${formData.targetEnvironment || 'N/A'}

            **Features:**
            \`\`\`
            ${features}
            \`\`\`

            ---

            ### Next Step: Stage 3 - Review & Confirm

            Click the link below to review and confirm your project:

            ### **[→ Continue to Stage 3 (Final)](${stage3Url})**

            ---
            Workflow ID: \`${workflowId}\``
            });

            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: [...context.payload.issue.labels.map(l => l.name), 'processed']
            });

            console.log(`Stage 3 form URL: ${stage3Url}`);

      # ----------------------------------------
      # Stage 3 -> Complete workflow
      # ----------------------------------------
      - name: "Stage 3 → Complete Wizard"
        if: steps.parse.outputs.stage == '3'
        uses: actions/github-script@v7
        with:
          script: |
            const formData = JSON.parse('${{ steps.parse.outputs.form_data }}');
            const workflowId = '${{ steps.parse.outputs.workflow_id }}';
            const repo = context.repo;

            // Load full state
            const stateIssues = await github.rest.issues.listForRepo({
              owner: repo.owner,
              repo: repo.repo,
              labels: 'workflow-state',
              state: 'open'
            });

            const stateIssue = stateIssues.data.find(i => i.title.includes(workflowId));
            let fullState = {};

            if (stateIssue) {
              const match = stateIssue.body.match(/```json\n([\s\S]*?)\n```/);
              if (match) {
                fullState = JSON.parse(match[1]);
              }
            }

            fullState.stage3 = formData;

            const confirmed = formData.confirmation === 'Yes, proceed';

            console.log('='.repeat(50));
            console.log('WIZARD COMPLETE');
            console.log('='.repeat(50));
            console.log(`Workflow ID: ${workflowId}`);
            console.log(`Confirmed: ${confirmed}`);
            console.log('Full collected data:');
            console.log(JSON.stringify(fullState, null, 2));
            console.log('='.repeat(50));

            // Create final summary
            const stage1 = fullState.stage1 || {};
            const stage2 = fullState.stage2 || {};
            const features = (stage2.requiredFeatures || [])
              .filter(f => f.checked)
              .map(f => `✓ ${f.label}`)
              .join('\n') || 'None';

            const finalSummary = `## Wizard Complete ${confirmed ? '✅' : '❌'}

            **Status:** ${confirmed ? 'CONFIRMED - Ready for resource creation' : 'CANCELLED'}

            ---

            ### Summary of All Stages

            | Stage | Field | Value |
            |-------|-------|-------|
            | 1 | Project Name | ${stage1.projectName || '-'} |
            | 1 | Project Type | ${stage1.projectType || '-'} |
            | 1 | Team Size | ${stage1.teamSize || '-'} |
            | 1 | Owner Email | ${stage1.ownerEmail || '-'} |
            | 2 | Language | ${stage2.primaryLanguage || '-'} |
            | 2 | Framework | ${stage2.framework || '-'} |
            | 2 | Environment | ${stage2.targetEnvironment || '-'} |
            | 3 | Confirmation | ${formData.confirmation || '-'} |

            ### Features Selected
            \`\`\`
            ${features}
            \`\`\`

            ### Project Description
            > ${stage1.projectDescription || 'N/A'}

            ${formData.additionalNotes ? `### Additional Notes\n> ${formData.additionalNotes}` : ''}

            ---
            **Workflow ID:** \`${workflowId}\`
            **Run ID:** \`${{ github.run_id }}\``;

            // Post final summary and close
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: finalSummary
            });

            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: [...context.payload.issue.labels.map(l => l.name), 'processed', 'completed']
            });

            // Close state issue
            if (stateIssue) {
              await github.rest.issues.update({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: stateIssue.number,
                state: 'closed'
              });
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: stateIssue.number,
                body: `Wizard completed. Final state:\n\n\`\`\`json\n${JSON.stringify(fullState, null, 2)}\n\`\`\``
              });
            }

            if (confirmed) {
              console.log('Project confirmed! Ready for resource creation.');
            } else {
              console.log('Project cancelled by user.');
            }
